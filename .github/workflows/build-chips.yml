name: Build All Custom Chips

on:
  push:
  workflow_dispatch:

jobs:
  build-all-chips:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Compile each chip in wokwi/chips/*
        shell: bash
        run: |
          for dir in wokwi/chips/*/; do
            chip_name=$(basename "$dir")
            echo "üîß Compilando chip: $chip_name"
            
            chip_c="$dir/${chip_name}.chip.c"
            chip_json="$dir/${chip_name}.chip.json"
            wasm_out="$dir/${chip_name}.chip.wasm"

            if [ -f "$chip_c" ]; then
              echo "üì¶ Compilando $chip_c ‚Üí $wasm_out"
              npx wokwi-cli compile --chip "$chip_c" --output "$wasm_out"
            else
              echo "‚ö†Ô∏è Arquivo $chip_c n√£o encontrado. Pulando..."
              continue
            fi

            if [ -f "$chip_json" ]; then
              echo "‚úÖ JSON encontrado: $chip_json"
            else
              echo "‚ö†Ô∏è JSON n√£o encontrado: $chip_json"
            fi
          done

      - name: Upload todos os .wasm e .json como artefatos
        uses: actions/upload-artifact@v4
        with:
          name: all-chips
          path: wokwi/chips/**/**/*.chip.*